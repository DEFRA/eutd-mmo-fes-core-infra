name: $(BuildID)

trigger: none

# Schedule configuration
schedules:
  - cron: "0 19 * * 1-5"
    displayName: Daily Delete at 7:00 PM UTC
    branches:
      include:
        - main
    always: true

resources:
  repositories:
    - repository: MMOPipelineCommon
      name: "DEFRA/eutd-mmo-fes-pipeline-common"
      endpoint: DEFRA
      type: github
      ref: refs/heads/main

extends:
  template: /includes/ssv-script-deploy.yaml@MMOPipelineCommon
  parameters:
    scriptsList:
      - displayName: "Get WebApps Existing Version"
        scriptRepo: MMOPipelineCommon
        scriptPath: "scripts/Get-ExistingWebAppVersion.ps1"
        condition: and(succeeded(), eq(variables['ephemeral'], true))
        ScriptArguments: -WebAppNames '$(webAppNames)' -ResourceGroupName '$(appEnvWebAppRgName)' -IsSlotsEnabled $$(slotsEnabled)
      - displayName: "Re-tag Ephemeral Image"
        scriptRepo: MMOPipelineCommon
        scriptPath: "scripts/Set-EphemeralTag.ps1"
        condition: and(succeeded(), eq(variables['ephemeral'], true))
        ScriptArguments: -acrName '$(acrName)'
      - displayName: "Get functionApps Existing Version"
        scriptRepo: MMOPipelineCommon
        scriptPath: "scripts/Get-ExistingWebAppVersion.ps1"
        condition: and(succeeded(), eq(variables['ephemeral'], true))
        ScriptArguments: -WebAppNames '$(functionApps)' -ResourceGroupName '$(appEnvWebAppRgName)' -IsSlotsEnabled $$(slotsEnabled)
      - displayName: "Re-tag Ephemeral Image"
        scriptRepo: MMOPipelineCommon
        scriptPath: "scripts/Set-EphemeralTag.ps1"
        condition: and(succeeded(), eq(variables['ephemeral'], true))
        ScriptArguments: -acrName '$(acrName)'
      - displayName: "Remove RoleAssignments"
        scriptRepo: MMOPipelineCommon
        scriptPath: "scripts/Remove-RoleAssignments.ps1"
        condition: and(succeeded(), eq(variables['ephemeral'], true))
        ScriptArguments: -ResourceName '$(acrName)' -ResourceGroupName '$(acrResourceGroup)' -ResourceType 'Microsoft.ContainerRegistry/registries' -RoleDefinitionName 'AcrPull' -AppsResourceGroup '$(appEnvWebAppRgName)'
